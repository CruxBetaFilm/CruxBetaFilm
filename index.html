<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crux&Beta Film - Fotograf√≠a & Video</title>

  <!-- Tailwind CDN (ok para pruebas; en producci√≥n conviene build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --black:#0a0a0a; --gray-900:#121212; --gray-800:#1e1e1e; --border:rgba(255,255,255,.14);
      --gold:#c8a035; --gold-2:#a07a18; --gold-3:#f3e2a5; --accent:#c47c3b;
    }
    html,body{height:100%}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--black); color:#ececec
    }
    .hidden-route{display:none!important}
    .subtext{color:#d8d8d8}
    body.lock{height:100vh;overflow:hidden}

    /* ===== Botones / paneles ===== */
    .btn-gold{position:relative;overflow:hidden;background:linear-gradient(180deg,var(--gold-3),var(--gold));color:#141414;border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 28px rgba(200,160,53,.22);transition:transform .18s ease,filter .18s ease}
    .btn-gold:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .btn-gold-outline{position:relative;overflow:hidden;background:rgba(255,255,255,.02);color:var(--gold-3);border:1px solid rgba(200,160,53,.55);box-shadow:0 8px 24px rgba(0,0,0,.24);transition:transform .18s ease,filter .18s ease}
    .btn-gold-outline:hover{transform:translateY(-1px);filter:brightness(1.08)}
    .btn-sheen::after{content:"";position:absolute;inset:0;transform:translateX(-120%) skewX(12deg);background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);animation:sheen 2.2s infinite;mix-blend-mode:screen}
    @keyframes sheen{0%{transform:translateX(-120%) skewX(12deg)}60%{transform:translateX(120%) skewX(12deg)}100%{transform:translateX(120%) skewX(12deg)}}

    .panel{position:relative;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid var(--border);box-shadow:0 20px 50px rgba(0,0,0,.6);backdrop-filter:blur(8px);border-radius:16px}
    .card{position:relative;border:1px solid var(--border);background:rgba(255,255,255,.04);box-shadow:0 0 0 1px rgba(255,255,255,.02) inset,0 20px 60px -20px rgba(0,0,0,.6);transition:transform .25s ease,box-shadow .25s ease,border-color .25s ease;border-radius:14px}
    .card:hover{transform:translateY(-4px);box-shadow:0 0 0 1px rgba(212,175,55,.18) inset,0 30px 80px -20px rgba(212,175,55,.25);border-color:rgba(212,175,55,.35)}
    .badge-accent{background:linear-gradient(180deg,rgba(196,124,59,.95),rgba(160,122,24,.95));color:#fff;border:1px solid rgba(255,255,255,.18)}

    /* ===== Portafolio ===== */
    .tabbar{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
    .tab-btn{padding:.55rem 1rem;border:1px solid rgba(200,160,53,.45);border-radius:9999px;font-weight:800;letter-spacing:.2px;background:rgba(255,255,255,.02);color:var(--gold-3);cursor:pointer;transition:.18s}
    .tab-btn:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .tab-btn.active{background:linear-gradient(180deg,var(--gold-3),var(--gold));color:#111;box-shadow:0 8px 22px rgba(200,160,53,.28)}
    .subtabs{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin:.75rem 0 1.25rem}
    .subtab-btn{padding:.4rem .85rem;border:1px dashed rgba(200,160,53,.35);border-radius:9999px;font-weight:700;color:#e7e7e7;background:rgba(255,255,255,.02);cursor:pointer}
    .subtab-btn.active{border-style:solid;color:#111;background:linear-gradient(180deg,var(--gold-3),var(--gold))}

    /* GRID con alturas variables, mantiene el orden de 1..43 */
    .grid-wrap{
      display:grid;
      grid-template-columns:repeat(1,minmax(0,1fr));
      grid-auto-rows:8px;
      gap:16px;
    }
    @media(min-width:640px){.grid-wrap{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1024px){.grid-wrap{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(min-width:1280px){.grid-wrap{grid-template-columns:repeat(4,minmax(0,1fr))}}

    .slot{
      position:relative;border:1px solid var(--border);border-radius:14px;overflow:hidden;
      background:rgba(255,255,255,.04);
      box-shadow:0 0 0 1px rgba(255,255,255,.02) inset, 0 20px 60px -20px rgba(0,0,0,.6);
      -webkit-user-select:none;user-select:none;-webkit-user-drag:none;
    }
    .slot img{display:block;width:100%;height:auto}
    .slot--empty{display:flex;align-items:center;justify-content:center;min-height:160px;border:1px dashed rgba(200,160,53,.35);background:linear-gradient(180deg,rgba(255,255,255,.015),rgba(255,255,255,.03));color:#cbb77a;border-radius:14px}
    .slot--empty .plus{font-size:28px;line-height:1;opacity:.7}

    /* Lightbox */
    #lightbox::backdrop{background:rgba(0,0,0,.85)}
    #lightbox[open]{padding:0;border:0;background:transparent}
    #lightbox{padding:0;border:0;background:transparent}
    .lb-stage{position:relative;display:flex;align-items:center;justify-content:center;padding:12px}
    .lb-inner{
      position:relative;
      width:auto; height:auto;
      max-width:92vw; max-height:92vh;
      overflow:hidden;border-radius:12px;margin:auto;background:#000;touch-action:none;
    }
    .lb-img{
      display:block;max-width:100%;max-height:100%;
      width:auto;height:auto;object-fit:contain;
      user-select:none;-webkit-user-drag:none;
      transform:translate(0,0) scale(1);
      will-change:transform;
      cursor:zoom-in;
    }
    .lb-close{
      position:absolute;top:8px;right:8px;z-index:3;
      width:40px;height:40px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.6);color:#fff;font-size:22px;line-height:40px;text-align:center;
    }
    .lb-close:hover{background:rgba(0,0,0,.8)}
    .lb-ctrl{
      position:absolute;top:50%;transform:translateY(-50%);
      background:rgba(0,0,0,.6);color:#fff;border:1px solid rgba(255,255,255,.25);
      width:44px;height:44px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:24px
    }
    .lb-ctrl:hover{background:rgba(0,0,0,.8)}
    #lbPrev{left:8px} #lbNext{right:8px}

    .lb-zoom-hint{
      position:absolute;right:56px;top:8px;z-index:3;
      display:flex;align-items:center;gap:6px;
      background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.2);
      padding:6px 10px;border-radius:10px;font-size:13px
    }
    .lb-zoom-hint svg{width:18px;height:18px}

    img{user-select:none;-webkit-user-drag:none}
  </style>
</head>

<body class="min-h-screen">
  <!-- HOME -->
  <section data-route="home" class="min-h-screen flex items-center justify-center relative overflow-hidden px-6">
    <div class="pointer-events-none absolute inset-0 opacity-25 grayscale bg-[url('https://images.unsplash.com/photo-1499084732479-de2c02d45fc4?q=80&w=1600&auto=format&fit=crop')] bg-cover bg-center"></div>
    <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-black/60 to-black/90"></div>
    <div class="relative z-10 text-center max-w-3xl">
      <img src="https://raw.githubusercontent.com/edgarces9/Mi-primera-p-gina-/main/IMG_1135.png" alt="Logo de Crux&Beta Film" class="mx-auto mb-5 rounded-full w-32 h-32 border border-white/20 object-cover"/>
      <h1 class="text-4xl sm:text-6xl font-black tracking-tight bg-clip-text text-transparent" style="background-image:linear-gradient(90deg,var(--gold-3),var(--gold),var(--gold-2))">Crux&Beta Film</h1>
      <p class="mt-3 text-lg sm:text-2xl subtext">Fotograf√≠a &amp; Video con un look formal y atemporal</p>
      <nav class="mt-7 flex flex-wrap items-center justify-center gap-3" aria-label="Navegaci√≥n principal">
        <a href="#paquetes"  class="btn-gold btn-sheen font-extrabold px-6 py-3 rounded-full">Ver paquetes</a>
        <a href="#contacto"  class="btn-gold-outline btn-sheen font-extrabold px-6 py-3 rounded-full">Contacto</a>
        <a href="#portafolio" class="btn-gold-outline btn-sheen font-extrabold px-6 py-3 rounded-full">Portafolio</a>
        <a href="#opiniones" class="btn-gold-outline btn-sheen font-extrabold px-6 py-3 rounded-full">Opiniones</a>
      </nav>
    </div>
  </section>

  <!-- PAQUETES -->
  <section data-route="paquetes" class="hidden-route min-h-screen flex items-center justify-center px-4 py-12">
    <div class="panel max-w-6xl w-full rounded-2xl p-6 sm:p-10 bg-black/40">
      <div class="flex items-center gap-3 mb-6">
        <a href="#home" class="btn-gold-outline btn-sheen px-4 py-2 rounded-full font-bold">‚Üê Volver</a>
        <h2 class="text-3xl sm:text-4xl font-extrabold">Paquetes</h2>
      </div>

      <div class="text-center mb-10">
        <h3 class="text-4xl font-extrabold mb-2" style="color:var(--gold-3)">Construye la imagen de tu negocio</h3>
        <p class="subtext text-lg sm:text-xl">Selecciona el paquete que mejor se adapte a tus objetivos.</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="card p-6">
          <div class="flex flex-col h-full">
            <h4 class="text-2xl font-extrabold mb-2" style="color:var(--gold-3)">Paquete Inicio</h4>
            <p class="text-sm subtext mb-4">Ideal para comenzar a impulsar tu marca.</p>
            <div class="text-4xl font-extrabold mb-4">$8,900 MXN</div>
            <ul class="space-y-3 text-base list-disc list-inside flex-grow subtext">
              <li><strong class="text-white">20 fotograf√≠as</strong> editadas</li>
              <li><strong class="text-white">3 videos cortos</strong> (30‚Äì45s)</li>
            </ul>
            <a href="#contacto" class="btn-gold btn-sheen px-5 py-2 rounded-full font-bold mt-6 text-center">Contratar</a>
          </div>
        </div>

        <div class="card p-8 bg-white/5 ring-2 ring-[color:var(--gold-3)] transform scale-105 transition-all duration-300 relative">
          <span class="badge-accent absolute top-0 right-0 -mt-3 -mr-3 px-3 py-1 text-sm font-bold rounded-full shadow-lg">M√°s Popular</span>
          <div class="flex flex-col h-full">
            <h4 class="text-3xl font-extrabold mb-2" style="color:var(--gold-3)">Paquete Crecimiento</h4>
            <p class="text-sm subtext mb-4">Acelera tu crecimiento con contenido completo.</p>
            <div class="text-5xl font-extrabold mb-4">$13,900 MXN</div>
            <ul class="space-y-3 text-base list-disc list-inside flex-grow subtext">
              <li><strong class="text-white">30 fotograf√≠as</strong> editadas</li>
              <li><strong class="text-white">5 videos cortos</strong> (30‚Äì45s)</li>
              <li><strong class="text-white">1 video largo</strong> (1‚Äì2 min)</li>
            </ul>
            <a href="#contacto" class="btn-gold btn-sheen px-5 py-2 rounded-full font-bold mt-6 text-center">Contratar</a>
          </div>
        </div>

        <div class="card p-6">
          <div class="flex flex-col h-full">
            <h4 class="text-2xl font-extrabold mb-2" style="color:var(--gold-3)">Paquete Impacto</h4>
            <p class="text-sm subtext mb-4">Campa√±a integral para dominar tu mercado.</p>
            <div class="text-4xl font-extrabold mb-4">$21,900 MXN</div>
            <ul class="space-y-3 text-base list-disc list-inside flex-grow subtext">
              <li><strong class="text-white">50 fotograf√≠as</strong> editadas</li>
              <li><strong class="text-white">8 videos cortos</strong> (30‚Äì45s)</li>
              <li><strong class="text-white">2 videos largos</strong> (1‚Äì2 min)</li>
              <li><strong class="text-white">10 fotos de producto</strong> adicionales</li>
            </ul>
            <a href="#contacto" class="btn-gold btn-sheen px-5 py-2 rounded-full font-bold mt-6 text-center">Contratar</a>
          </div>
        </div>
      </div>

      <div class="text-center subtext mt-12 text-sm sm:text-base">
        <p class="mb-2">‚ö° Edici√≥n profesional y entrega digital en alta calidad.</p>
        <p class="mb-2">üí≥ 50% de anticipo para reservar fecha.</p>
        <p class="mb-2 font-extrabold text-white">‚è≥ Entrega estimada: 7 d√≠as h√°biles.</p>
        <p>üìå Precios sujetos a IVA.</p>
      </div>
    </div>
  </section>

  <!-- OPINIONES -->
  <section data-route="opiniones" class="hidden-route min-h-screen flex items-center justify-center px-4 py-10">
    <div class="panel max-w-5xl w-full p-6 sm:p-10 bg-black/40">
      <div class="flex items-center gap-3 mb-6">
        <a href="#home" class="btn-gold-outline btn-sheen px-4 py-2 rounded-full font-bold">‚Üê Volver</a>
        <h2 class="text-3xl sm:text-4xl font-extrabold">Opiniones</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <blockquote class="card p-6"><h4 class="text-lg font-extrabold mb-2" style="color:var(--gold-3)">‚ÄúExcelente experiencia‚Äù</h4><p class="subtext">‚ÄúSubi√≥ nuestras reservas en brunch en 3 semanas. Fotograf√≠a que parece cine.‚Äù ‚Äî Cornalina</p></blockquote>
        <blockquote class="card p-6"><h4 class="text-lg font-extrabold mb-2" style="color:var(--gold-3)">‚ÄúEntrega puntual‚Äù</h4><p class="subtext">‚ÄúFotos y video highlight justo como lo quer√≠amos. Recomendado.‚Äù ‚Äî Cliente social</p></blockquote>
      </div>
    </div>
  </section>

  <!-- PORTAFOLIO -->
  <section data-route="portafolio" class="hidden-route min-h-screen flex items-center justify-center px-4 py-10">
    <div class="panel max-w-7xl w-full p-6 sm:p-10 bg-black/40">
      <div class="flex items-center gap-3 mb-6">
        <a href="#home" class="btn-gold-outline btn-sheen px-4 py-2 rounded-full font-bold">‚Üê Volver</a>
        <h2 class="text-3xl sm:text-4xl font-extrabold">Portafolio</h2>
      </div>

      <div class="tabbar mb-6" role="tablist" aria-label="Categor√≠as principales">
        <button class="tab-btn active" data-tab="fotografia" role="tab" aria-controls="tab-fotografia">Fotograf√≠a</button>
        <button class="tab-btn" data-tab="video" role="tab" aria-controls="tab-video">Video</button>
      </div>

      <section id="tab-fotografia" class="tab-pane">
        <div class="subtabs" role="tablist" aria-label="Subcategor√≠as fotograf√≠a">
          <button class="subtab-btn active" data-subtab="producto" role="tab" aria-controls="sub-producto">Producto</button>
          <button class="subtab-btn" data-subtab="registro" role="tab" aria-controls="sub-registro">Registro</button>
        </div>
        <div id="sub-producto" class="subpane">
          <div class="grid-wrap" id="grid-producto" aria-live="polite"></div>
        </div>
        <div id="sub-registro" class="subpane hidden">
          <div class="grid-wrap" id="grid-registro" aria-live="polite"></div>
        </div>
      </section>

      <section id="tab-video" class="tab-pane hidden">
        <div class="subtabs" role="tablist" aria-label="Subcategor√≠as video">
          <button class="subtab-btn active" data-subtab="general" role="tab" aria-controls="sub-general">General</button>
          <button class="subtab-btn" data-subtab="redes" role="tab" aria-controls="sub-redes">Redes Sociales</button>
        </div>
        <div id="sub-general" class="subpane">
          <div class="grid-wrap" id="grid-video-general" aria-live="polite"></div>
        </div>
        <div id="sub-redes" class="subpane hidden">
          <div class="grid-wrap" id="grid-video-redes" aria-live="polite"></div>
        </div>
      </section>
    </div>
  </section>

  <!-- CONTACTO -->
  <section data-route="contacto" class="hidden-route min-h-screen flex items-center justify-center px-4 py-10">
    <div class="panel max-w-5xl w-full p-6 sm:p-10 bg-black/40">
      <div class="flex items-center gap-3 mb-6">
        <a href="#home" class="btn-gold-outline btn-sheen px-4 py-2 rounded-full font-bold">‚Üê Volver</a>
        <h2 class="text-3xl sm:text-4xl font-extrabold">Contacto</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card p-6"><h4 class="text-lg font-extrabold mb-2" style="color:var(--gold-3)">WhatsApp</h4><p class="subtext">Tap para conversar: <a href="https://tapni.com/cruxbetafilm" class="underline" target="_blank" rel="noopener">cruxbetafilm</a></p><a href="https://tapni.com/cruxbetafilm" target="_blank" rel="noopener" class="btn-gold btn-sheen mt-4 inline-block px-5 py-2 rounded-full font-bold">Abrir chat</a></div>
        <div class="card p-6"><h4 class="text-lg font-extrabold mb-2" style="color:var(--gold-3)">Cobertura</h4><p class="subtext">Monterrey y √°rea metropolitana. Viajes a otros estados bajo agenda.</p></div>
        <div class="card p-6"><h4 class="text-lg font-extrabold mb-2" style="color:var(--gold-3)">Entrega</h4><p class="subtext">Fotos en 7 d√≠as. Video highlight en 7‚Äì10 d√≠as.</p></div>
      </div>
    </div>
  </section>

  <!-- LIGHTBOX -->
  <dialog id="lightbox">
    <div class="lb-stage">
      <button id="lbClose" class="lb-close" aria-label="Cerrar">√ó</button>
      <div class="lb-zoom-hint" id="lbHint" aria-hidden="true" title="Clic para ampliar / otro clic para salir de zoom">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.49 21.49 20l-5.99-6zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5z"/></svg>
        <span>Zoom</span>
      </div>
      <button id="lbPrev" class="lb-ctrl" aria-label="Anterior">‚Äπ</button>
      <div class="lb-inner" id="lbInner">
        <img id="lbImg" class="lb-img" alt="Foto" />
      </div>
      <button id="lbNext" class="lb-ctrl" aria-label="Siguiente">‚Ä∫</button>
    </div>
  </dialog>

  <!-- MODAL video -->
  <dialog id="videoModal" style="padding:0;border:0;background:transparent">
    <div style="position:relative;width:min(92vw,1000px);aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden">
      <iframe id="videoFrame" src="" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0"></iframe>
    </div>
  </dialog>

  <script>
    /* ====== Router por hash ====== */
    (function(){
      const sections = Array.from(document.querySelectorAll('[data-route]'));
      const routes = sections.map(s => s.getAttribute('data-route'));
      let portfolioInitialized = false;

      function show(route){
        sections.forEach(s => s.classList.toggle('hidden-route', s.getAttribute('data-route')!==route));
        document.body.classList.toggle('lock', route==='home');
        window.scrollTo({ top: 0, behavior: 'auto' });

        if (route === 'portafolio') {
          if (!portfolioInitialized) {
            initPortfolio(false);     // ya precargamos; aqu√≠ solo reflow final
            portfolioInitialized = true;
          } else {
            reflowGrid(gridProducto);
          }
        }
      }
      function render(){
        let route = (location.hash || '#home').slice(1);
        if (!routes.includes(route)) route = 'home';
        show(route);
      }
      window.addEventListener('hashchange', render);
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[href^="#"]');
        if (!a) return;
        const target = (a.getAttribute('href') || '#home').slice(1);
        if (routes.includes(target)) {
          e.preventDefault();
          if (location.hash.slice(1) !== target) location.hash = '#' + target;
          else show(target);
        }
      });
      render();

      // üî• Precarga del portafolio apenas se monta la p√°gina
      window.addEventListener('DOMContentLoaded', () => {
        initPortfolio(true); // preloadOnly = true (carga archivos en bg)
      });
    })();

    /* ====== Helpers Portafolio ====== */
    function videoThumb(url){
      const yt = String(url).match(/(?:youtube\.com\/(?:embed\/|watch\?v=)|youtu\.be\/)([\w-]{6,})/);
      if (yt) return `https://img.youtube.com/vi/${yt[1]}/hqdefault.jpg`;
      const vm = String(url).match(/vimeo\.com\/(?:video\/)?(\d+)/);
      if (vm) return 'https://via.placeholder.com/800x450?text=Vimeo+Video';
      return 'https://via.placeholder.com/800x450?text=Video';
    }

    function renderVideos(list, grid){
      grid.innerHTML = '';
      const MAX = 10;
      const filled = (list || []).slice(0,MAX);
      filled.forEach((url,i)=>{
        const div = document.createElement('div');
        div.className = 'slot';
        const img = document.createElement('img');
        img.src = videoThumb(url);
        img.alt = `Video ${i+1}`;
        img.loading = 'lazy';
        img.decoding = 'async';
        div.appendChild(img);
        div.addEventListener('click', ()=> openVideo(url));
        grid.appendChild(div);
      });
      for(let i=filled.length;i<MAX;i++){
        const ph = document.createElement('div');
        ph.className = 'slot--empty';
        ph.innerHTML = `<div class='plus'>+ slot ${i+1}/10</div>`;
        grid.appendChild(ph);
      }
    }

    /* ====== Lightbox con Zoom + Arrastre (sin zoom autom√°tico al abrir) ====== */
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lbImg');
    const lbInner = document.getElementById('lbInner');
    const lbPrev = document.getElementById('lbPrev');
    const lbNext = document.getElementById('lbNext');
    const lbClose = document.getElementById('lbClose');
    const lbHint  = document.getElementById('lbHint');

    let currentList = [], currentIdx = 0;
    let scale = 1, tx = 0, ty = 0;
    let dragging = false, startX = 0, startY = 0, startTx = 0, startTy = 0, moved = false;
    let justOpened = false;

    function applyTransform(){
      lbImg.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
      lbImg.style.cursor = scale>1 ? (dragging ? 'grabbing' : 'grab') : 'zoom-in';
    }
    function resetZoom(){ scale = 1; tx = 0; ty = 0; applyTransform(); }

    function fitLightboxToImage(nw, nh){
      // Ajusta lbInner al tama√±o m√°ximo posible respetando aspecto
      const maxW = Math.min(window.innerWidth * 0.92, 1200);
      const maxH = window.innerHeight * 0.92;
      const ratio = Math.min(maxW / nw, maxH / nh, 1);
      const w = Math.max(1, Math.floor(nw * ratio));
      const h = Math.max(1, Math.floor(nh * ratio));
      lbInner.style.width  = w + 'px';
      lbInner.style.height = h + 'px';
    }

    function loadLbImage(url, showHint){
      resetZoom();
      lbImg.onload = () => {
        fitLightboxToImage(lbImg.naturalWidth, lbImg.naturalHeight);
        if (showHint) {
          lbHint.style.display = 'flex';
          setTimeout(()=>{ lbHint.style.display='none'; }, 2000);
        }
      };
      lbImg.src = url;
    }

    function openLightbox(list,i){
      currentList=list; currentIdx=i;
      justOpened = true;
      loadLbImage(list[i], true);
      if (typeof lb.showModal==='function') lb.showModal(); else lb.setAttribute('open','');
      // Anti-‚Äúzoom fantasma‚Äù del primer click
      setTimeout(()=>{ justOpened = false; }, 200);
    }
    function closeLightbox(){ resetZoom(); lb.close(); }
    lbClose.addEventListener('click', closeLightbox);
    window.addEventListener('resize', () => {
      // Reajusta al redimensionar
      if (lb.open) fitLightboxToImage(lbImg.naturalWidth||1, lbImg.naturalHeight||1);
    });

    function nav(step){
      if (!currentList.length) return;
      currentIdx=(currentIdx+step+currentList.length)%currentList.length;
      loadLbImage(currentList[currentIdx], false);
    }
    lbPrev.addEventListener('click', ()=> nav(-1));
    lbNext.addEventListener('click', ()=> nav(1));

    // Zoom manual con click (sin arrastre) + arrastre cuando hay zoom
    lbInner.addEventListener('pointerdown',(e)=>{
      if (e.button !== 0) return;
      lbInner.setPointerCapture(e.pointerId);
      moved = false;
      if (scale>1){
        dragging = true; startX = e.clientX; startY = e.clientY; startTx = tx; startTy = ty;
        lbImg.style.cursor = 'grabbing';
      }
    });
    lbInner.addEventListener('pointermove',(e)=>{
      if (!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if (Math.abs(dx) > 3 || Math.abs(dy) > 3) moved = true;
      tx = startTx + dx; ty = startTy + dy;
      applyTransform();
    });
    lbInner.addEventListener('pointerup',(e)=>{
      lbInner.releasePointerCapture(e.pointerId);
      if (justOpened) return; // evita togglear zoom por el click que abri√≥
      if (dragging){
        dragging = false;
        applyTransform();
        if (!moved){ toggleZoom(e.clientX, e.clientY); }
      } else {
        toggleZoom(e.clientX, e.clientY);
      }
    });

    function toggleZoom(clientX, clientY){
      if (scale === 1){
        scale = 2.5;
        // Centra el zoom hacia donde hiciste click
        const rect = lbImg.getBoundingClientRect();
        const cx = clientX - rect.left - rect.width/2;
        const cy = clientY - rect.top  - rect.height/2;
        tx = -cx*(scale-1); ty = -cy*(scale-1);
      } else {
        resetZoom();
      }
      applyTransform();
    }

    window.addEventListener('keydown',(e)=>{
      if(!lb.open) return;
      if(e.key==='Escape') closeLightbox();
      if(e.key==='ArrowLeft') nav(-1);
      if(e.key==='ArrowRight') nav(1);
    });

    lb.addEventListener('click', (e)=>{
      const innerRect = lbInner.getBoundingClientRect();
      const outside = e.clientX<innerRect.left||e.clientX>innerRect.right||e.clientY<innerRect.top||e.clientY>innerRect.bottom;
      if(outside) closeLightbox();
    });

    /* ====== Tabs (Portafolio) ====== */
    const mainTabs = document.querySelectorAll('.tab-btn');
    const panes = { fotografia: document.getElementById('tab-fotografia'), video: document.getElementById('tab-video') };
    mainTabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(!btn.dataset.tab) return;
        mainTabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const t = btn.dataset.tab;
        if(panes.fotografia && panes.video){
          panes.fotografia.classList.toggle('hidden', t!=='fotografia');
          panes.video.classList.toggle('hidden', t!=='video');
        }
        // opcional: reflow al cambiar de pesta√±a
        if (t==='fotografia') reflowGrid(gridProducto);
      });
    });

    const fotoSubBtns = document.querySelectorAll('#tab-fotografia .subtab-btn');
    const subFoto = { producto: document.getElementById('sub-producto'), registro: document.getElementById('sub-registro') };
    fotoSubBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        fotoSubBtns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const t = btn.dataset.subtab;
        Object.entries(subFoto).forEach(([k,el])=> el.classList.toggle('hidden', k!==t));
        reflowGrid(gridProducto);
      });
    });

    const videoSubBtns = document.querySelectorAll('#tab-video .subtab-btn');
    const subVid = { general: document.getElementById('sub-general'), redes: document.getElementById('sub-redes') };
    videoSubBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        videoSubBtns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const t = btn.dataset.subtab;
        Object.entries(subVid).forEach(([k,el])=> el.classList.toggle('hidden', k!==t));
      });
    });

    /* ====== Autollenado desde /img/producto ====== */
    const gridProducto = document.getElementById('grid-producto');
    const PRODUCTO_DIR   = './img/producto/';
    const PRODUCTO_COUNT = 43; // foto (1) ... foto (43)

    const EXT_CANDIDATAS = ['jpg','jpeg','png','webp','JPG','JPEG','PNG','WEBP'];
    const EXT_MAP = {5:'jpeg',6:'jpeg',7:'jpeg',8:'jpeg',9:'jpeg',10:'jpeg',11:'jpeg',18:'png',19:'png',20:'png',21:'png',39:'png',40:'png',41:'png',42:'png',43:'png'};

    function posiblesURLs(baseDir, i) {
      const conEspacio = `foto (${i})`;
      const sinEspacio = `foto(${i})`;
      const exts = EXT_MAP[i] ? [EXT_MAP[i], ...EXT_CANDIDATAS] : EXT_CANDIDATAS;
      const urls = [];
      for (const ext of exts) {
        urls.push(baseDir + encodeURIComponent(`${conEspacio}.${ext}`));
        urls.push(baseDir + encodeURIComponent(`${sinEspacio}.${ext}`));
      }
      return Array.from(new Set(urls));
    }

    function cargarConFallback(imgEl, urls, onOk, onFail, idx = 0) {
      if (idx >= urls.length) { onFail(); return; }
      imgEl.onload = () => onOk(urls[idx], imgEl);
      imgEl.onerror = () => cargarConFallback(imgEl, urls, onOk, onFail, idx + 1);
      imgEl.src = urls[idx];
    }

    // abre lightbox desde la URL correcta preservando orden visible
    function openLightboxFrom(okUrl, visibles){
      const idxVisible = visibles.indexOf(okUrl);
      openLightbox(visibles, Math.max(idxVisible,0));
    }

    function renderFotosDesdeCarpetaRobusto(grid, baseDir, count, {preloadOnly=false} = {}) {
      if (!grid || count <= 0) return;
      if (!preloadOnly) grid.innerHTML = ''; // si es precarga, no toques DOM visible

      const urlsOK = [];
      const fallidas = [];
      const preloadBucket = []; // para precarga con Image()

      for (let i = 1; i <= count; i++) {
        const candidatos = posiblesURLs(baseDir, i);

        if (preloadOnly) {
          // üî• Precarga en bg (sin afectar layout)
          const img = new Image();
          img.decoding = 'async';
          img.loading = 'eager';
          cargarConFallback(
            img,
            candidatos,
            (okUrl) => { urlsOK[i] = okUrl; },
            () => { fallidas.push(i); }
          );
          preloadBucket.push(img);
          continue;
        }

        // Render normal (cuando ya entraste a #portafolio)
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'slot';

        const img = document.createElement('img');
        img.alt = `Foto ${i}`;
        img.setAttribute('draggable','false');
        // EAGER aqu√≠ para que ya est√©n en cach√© (las precargamos antes)
        img.loading = 'eager';
        img.decoding = 'async';

        a.appendChild(img);
        grid.appendChild(a);

        cargarConFallback(
          img,
          candidatos,
          (okUrl, el) => {
            urlsOK[i] = okUrl;
            a.href = okUrl;
            // span cuando la imagen tenga dimensiones
            if (el.complete) setGridSpanForItem(grid, a);
            else el.onload = ()=> setGridSpanForItem(grid, a);

            a.addEventListener('click', (e) => {
              e.preventDefault();
              const visibles = urlsOK.filter(Boolean);
              openLightboxFrom(okUrl, visibles);
            });
          },
          () => {
            fallidas.push(i);
            a.replaceChildren();
            const ph = document.createElement('div');
            ph.className = 'slot--empty';
            ph.innerHTML = `<div class='plus'>No encontrada<br><small>foto ${i}</small></div>`;
            a.appendChild(ph);
            setGridSpanForItem(grid, a);
          }
        );
      }

      if (!preloadOnly) {
        window.addEventListener('resize', ()=> reflowGrid(grid));
        setTimeout(()=> reflowGrid(grid), 150);
      }
    }

    // ==== Masonry-like por JS, SIN reordenar ====
    function setGridSpanForItem(grid, item){
      const rowHeight = parseInt(getComputedStyle(grid).getPropertyValue('grid-auto-rows'));
      const rowGap    = parseInt(getComputedStyle(grid).getPropertyValue('gap'));
      const content   = item.querySelector('img, .slot--empty');
      if (!content) return;
      const height = content.getBoundingClientRect().height || content.offsetHeight || 0;
      const span = Math.ceil( (height + rowGap) / (rowHeight + rowGap) );
      item.style.gridRowEnd = `span ${Math.max(span, 1)}`;
    }
    function reflowGrid(grid){
      Array.from(grid.children).forEach(item=> setGridSpanForItem(grid, item));
    }

    // Init portafolio
    function initPortfolio(preloadOnly){
      if (preloadOnly) {
        // solo dispara la descarga de archivos
        renderFotosDesdeCarpetaRobusto(gridProducto, PRODUCTO_DIR, PRODUCTO_COUNT, {preloadOnly:true});
      } else {
        // renderiza ya con im√°genes probablemente en cach√©
        renderFotosDesdeCarpetaRobusto(gridProducto, PRODUCTO_DIR, PRODUCTO_COUNT, {preloadOnly:false});
      }
    }
  </script>
</body>
</html>
